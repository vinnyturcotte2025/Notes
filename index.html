<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Notes by Enzo</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#020617" />

<!-- PWA Manifest -->
<link rel="manifest" href="data:application/json,{
  &quot;name&quot;:&quot;Notes by Enzo&quot;,
  &quot;short_name&quot;:&quot;EnzoNotes&quot;,
  &quot;start_url&quot;:&quot;.&quot;,
  &quot;display&quot;:&quot;standalone&quot;,
  &quot;background_color&quot;:&quot;#020617&quot;,
  &quot;theme_color&quot;:&quot;#020617&quot;
}">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<style>
* { box-sizing: border-box; }
body { margin:0; font-family:Arial,sans-serif; background:#020617; color:#e5e7eb; }
.layout { display:flex; height:100vh; }
.sidebar { width:270px; background:#020617; border-right:1px solid #1e293b; padding:16px; overflow-y:auto; }
.main { flex:1; padding:20px; display:flex; flex-direction:column; }
.sidebar h2 { text-align:center; margin-bottom:12px; }
.sidebar section { margin-bottom:18px; }
.sidebar h3 { margin:6px 0; font-size:0.75rem; color:#94a3b8; text-transform:uppercase; }
.sidebar button, .sidebar select, .sidebar input { width:100%; margin-bottom:6px; padding:8px; border-radius:8px; border:none; background:#2563eb; color:white; font-size:0.85rem; }
.sidebar input { background:#020617; border:1px solid #334155; color:#e5e7eb; }
.clip-list button { background:#475569; font-size:0.75rem; margin-bottom:4px; }
canvas { height:70px; width:100%; margin-bottom:8px; }
textarea { flex:1; width:100%; resize:none; padding:14px; border-radius:12px; border:1px solid #334155; background:transparent; color:#e5e7eb; font-size:1rem; }
.status, .muted { text-align:center; font-size:0.8rem; color:#94a3b8; margin-top:6px; }
</style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Notes by Enzo</h2>
    <section>
      <h3>Account</h3>
      <button id="loginBtn">ğŸ” Login</button>
      <button id="logoutBtn" hidden>ğŸšª Logout</button>
    </section>
    <section>
      <h3>Notebooks</h3>
      <select id="books"></select>
      <button id="newBook">â• New Notebook</button>
      <button id="shareBook">ğŸ¤ Share Notebook</button>
    </section>
    <section>
      <h3>Recording</h3>
      <button id="startRec">ğŸ™ Start</button>
      <button id="stopRec">â¹ Stop</button>
      <div id="recStatus" class="muted">Idle</div>
    </section>
    <section>
      <h3>Playback</h3>
      <div id="clips" class="clip-list muted">No clips yet</div>
    </section>
    <section>
      <h3>Intelligence</h3>
      <button id="aiSummary">ğŸ§  AI Summary</button>
      <button id="historyBtn">ğŸ•“ Version History</button>
    </section>
    <section>
      <h3>Settings</h3>
      <input id="apiKey" type="password" placeholder="AI API Key" />
    </section>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <canvas id="wave"></canvas>
    <textarea id="notes" placeholder="Speak. Think. Remember."></textarea>
    <div class="status" id="status">Idle</div>
  </main>

</div>

<script>
// ğŸ”¥ FIREBASE CONFIG â€” REPLACE WITH YOUR OWN
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const booksEl = document.getElementById("books");
const notesEl = document.getElementById("notes");
const clipsDiv = document.getElementById("clips");
const recStatus = document.getElementById("recStatus");
const statusEl = document.getElementById("status");
const apiKeyInput = document.getElementById("apiKey");

let user = null;
let currentBook = null;

// ---------------- AUTH ----------------
loginBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(u => {
  user = u;
  loginBtn.hidden = !!u;
  logoutBtn.hidden = !u;
  if (u) loadBooks();
  else {
    notesEl.value = "";
    booksEl.innerHTML = "";
    currentBook = null;
  }
});

// ---------------- NOTEBOOKS ----------------
function loadBooks() {
  db.collection("users").doc(user.uid).collection("notebooks")
    .onSnapshot(snap => {
      booksEl.innerHTML = "";
      snap.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.data().name;
        booksEl.appendChild(opt);
      });
      if (!currentBook && snap.docs.length > 0) selectBook(snap.docs[0].id);
    });
}

booksEl.onchange = e => selectBook(e.target.value);

function selectBook(id) {
  currentBook = id;
  db.collection("users").doc(user.uid).collection("notebooks").doc(id)
    .onSnapshot(doc => {
      notesEl.value = doc.data()?.text || "";
    });
  loadClips();
}

document.getElementById("newBook").onclick = async () => {
  const name = prompt("Notebook name?");
  if (!name) return;
  const ref = await db.collection("users").doc(user.uid).collection("notebooks").add({
    name,
    text: "",
    sharedWith: []
  });
  selectBook(ref.id);
};

document.getElementById("shareBook").onclick = () => {
  alert("Sharing requires email/UID mapping. Placeholder for now.");
};

// ---------------- NOTES SAVE ----------------
let saveTimer;
notesEl.oninput = () => {
  if (!user || !currentBook) return;
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    const ref = db.collection("users").doc(user.uid).collection("notebooks").doc(currentBook);
    ref.set({ text: notesEl.value, updated: Date.now() }, { merge: true });
    ref.collection("history").add({ text: notesEl.value, ts: Date.now() });
  }, 500);
};

// ---------------- AUDIO RECORDING ----------------
let mediaRecorder, audioChunks = [];

document.getElementById("startRec").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SR();
  rec.continuous = true;
  rec.onresult = e => {
    const t = new Date().toLocaleTimeString();
    notesEl.value += `\n[${t}] Speaker: ${e.results.at(-1)[0].transcript}`;
  };
  rec.start();

  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();

  const ac = new AudioContext();
  const analyser = ac.createAnalyser();
  ac.createMediaStreamSource(stream).connect(analyser);
  const canvas = document.getElementById("wave");
  const c = canvas.getContext("2d");
  const data = new Uint8Array(analyser.fftSize = 2048);

  (function draw(){
    requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(data);
    c.clearRect(0,0,canvas.width,canvas.height);
    c.beginPath();
    data.forEach((v,i)=>{
      const x=i/data.length*canvas.width;
      const y=v/255*canvas.height;
      i?c.lineTo(x,y):c.moveTo(x,y);
    });
    c.strokeStyle="#2563eb";
    c.stroke();
  })();

  recStatus.textContent = "Recordingâ€¦";
};

document.getElementById("stopRec").onclick = async () => {
  recStatus.textContent = "Idle";
  if (!mediaRecorder) return;
  mediaRecorder.stop();
  mediaRecorder.onstop = async () => {
    const blob = new Blob(audioChunks, { type: "audio/webm" });
    const ts = Date.now();
    const ref = storage.ref(`audio/${user.uid}/${currentBook}/${ts}.webm`);
    await ref.put(blob);
    const url = await ref.getDownloadURL();
    await db.collection("users").doc(user.uid).collection("notebooks").doc(currentBook)
      .collection("audio").add({ url, timestamp: ts });
    loadClips();
  };
};

// ---------------- PLAYBACK ----------------
function loadClips() {
  clipsDiv.innerHTML = "";
  db.collection("users").doc(user.uid).collection("notebooks").doc(currentBook)
    .collection("audio").orderBy("timestamp","desc")
    .onSnapshot(snap => {
      clipsDiv.innerHTML = "";
      snap.forEach(d => {
        const b = document.createElement("button");
        b.textContent = "â–¶ " + new Date(d.data().timestamp).toLocaleTimeString();
        b.onclick = () => new Audio(d.data().url).play();
        clipsDiv.appendChild(b);
      });
      if(snap.empty) clipsDiv.innerHTML="No clips yet";
    });
}

// ---------------- AI SUMMARY ----------------
document.getElementById("aiSummary").onclick = async () => {
  const key = apiKeyInput.value.trim();
  if(!key){
    alert("Offline summary: "+notesEl.value.split(/[.!?]/).slice(0,3).join(". "));
    return;
  }
  const r = await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{
      "Authorization":"Bearer "+key,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      model:"gpt-4o-mini",
      messages:[{role:"user", content:notesEl.value}]
    })
  });
  const j = await r.json();
  alert(j.choices[0].message.content);
};

// ---------------- HISTORY ----------------
document.getElementById("historyBtn").onclick = async () => {
  const snap = await db.collection("users").doc(user.uid).collection("notebooks").doc(currentBook)
    .collection("history").orderBy("ts","desc").limit(5).get();
  let out = "Recent versions:\n\n";
  snap.forEach(d => out += new Date(d.data().ts).toLocaleString()+"\n");
  alert(out);
};
</script>
</body>
</html>

