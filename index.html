<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Notes by Enzo</title>

<style>
  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #020617;
    color: #e5e7eb;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .app {
    width: 95%;
    max-width: 900px;
    background: #020617;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 0 50px rgba(0,0,0,0.6);
  }

  h1 {
    text-align: center;
    margin-bottom: 6px;
  }

  .subtitle {
    text-align: center;
    color: #94a3b8;
    margin-bottom: 16px;
    font-size: 0.9rem;
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 12px;
  }

  button, input {
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    font-size: 0.9rem;
  }

  button {
    background: #2563eb;
    color: white;
    cursor: pointer;
  }

  button.secondary {
    background: #475569;
  }

  textarea {
    width: 100%;
    height: 260px;
    background: transparent;
    color: #e5e7eb;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 12px;
    resize: none;
    margin-top: 10px;
  }

  canvas {
    width: 100%;
    height: 80px;
    background: #020617;
    border-radius: 10px;
    margin-top: 12px;
  }

  .status {
    text-align: center;
    font-size: 0.85rem;
    color: #94a3b8;
    margin-top: 8px;
  }

  .summary {
    margin-top: 14px;
    padding: 12px;
    background: rgba(37,99,235,0.1);
    border-radius: 10px;
    display: none;
  }

  .apikey {
    width: 100%;
    margin-top: 10px;
    background: #020617;
    color: #e5e7eb;
    border: 1px solid #334155;
  }
</style>
</head>

<body>
<div class="app">
  <h1>Notes by Enzo</h1>
  <div class="subtitle">Hear it. See it. Remember it.</div>

  <div class="controls">
    <button id="startBtn">üéô Start</button>
    <button id="stopBtn" disabled>‚èπ Stop</button>
    <button id="aiBtn" class="secondary">üß† AI Summary</button>
    <button id="clearBtn" class="secondary">üßπ Clear</button>
  </div>

  <canvas id="waveform"></canvas>

  <textarea id="notes" placeholder="Speaker-labeled notes appear here..."></textarea>

  <input
    id="apiKey"
    class="apikey"
    placeholder="Optional: Paste AI API Key for real summaries"
    type="password"
  />

  <div class="status" id="status">Idle</div>
  <div class="summary" id="summary"></div>
</div>

<script>
/* ---------- Persistence ---------- */
const notes = document.getElementById("notes");
const apiKeyInput = document.getElementById("apiKey");
notes.value = localStorage.getItem("enzo-notes") || "";
apiKeyInput.value = localStorage.getItem("enzo-key") || "";

notes.oninput = () => localStorage.setItem("enzo-notes", notes.value);
apiKeyInput.oninput = () => localStorage.setItem("enzo-key", apiKeyInput.value);

/* ---------- Waveform ---------- */
const canvas = document.getElementById("waveform");
const ctx = canvas.getContext("2d");
let analyser, dataArray, audioCtx, source;

function drawWave() {
  requestAnimationFrame(drawWave);
  if (!analyser) return;

  analyser.getByteTimeDomainData(dataArray);
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.lineWidth = 2;
  ctx.strokeStyle = "#2563eb";
  ctx.beginPath();

  const slice = canvas.width / dataArray.length;
  let x = 0;

  for (let i = 0; i < dataArray.length; i++) {
    const v = dataArray[i] / 128.0;
    const y = (v * canvas.height) / 2;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    x += slice;
  }

  ctx.stroke();
}

/* ---------- Speech + Speaker Detection ---------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const statusText = document.getElementById("status");
let recognition;
let speaker = 1;
let lastTime = Date.now();

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = e => {
    const now = Date.now();
    if (now - lastTime > 2000) speaker = speaker === 1 ? 2 : 1;
    lastTime = now;

    const text = e.results[e.results.length - 1][0].transcript.trim();
    notes.value += `\nSpeaker ${speaker}: ${text}.`;
    localStorage.setItem("enzo-notes", notes.value);
  };
}

startBtn.onclick = async () => {
  statusText.textContent = "Listening‚Ä¶";

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioCtx = new AudioContext();
  analyser = audioCtx.createAnalyser();
  source = audioCtx.createMediaStreamSource(stream);
  source.connect(analyser);

  analyser.fftSize = 2048;
  dataArray = new Uint8Array(analyser.fftSize);

  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;

  drawWave();
  recognition.start();

  startBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  recognition.stop();
  audioCtx && audioCtx.close();
  analyser = null;
  statusText.textContent = "Stopped";
  startBtn.disabled = false;
  stopBtn.disabled = true;
};

/* ---------- AI SUMMARY ---------- */
aiBtn.onclick = async () => {
  const key = apiKeyInput.value.trim();
  if (!key) {
    alert("Add an API key to use AI summaries.");
    return;
  }

  statusText.textContent = "Thinking‚Ä¶";

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + key
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "Summarize the following notes clearly." },
        { role: "user", content: notes.value }
      ]
    })
  });

  const data = await res.json();
  summary.innerText = data.choices[0].message.content;
  summary.style.display = "block";
  statusText.textContent = "Summary ready.";
};

clearBtn.onclick = () => {
  if (!confirm("Clear everything?")) return;
  notes.value = "";
  summary.style.display = "none";
  localStorage.clear();
};
</script>
</body>
</html>
